name: Testing
run-name: Testing Hub with pytestðŸ§ª
on:
  push:
    branches: [main, dev]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:latest
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: testdb

    env:
      DB_USER: testuser
      DB_PASSWORD: testpassword
      DB_NAME: testdb
      DB_PORT: 5432
      DB_HOST: localhost
      OPEN_AI_KEY: ${{secrets.OPEN_AI_KEY}}
      RUNPOD_KEY: ${{secrets.RUNPOD_KEY}}

      AWS_ACCESS_KEY_ID: ${{secrets.AWS_ACCESS_KEY_ID}}
      AWS_SECRET_ACCESS_KEY: ${{secrets.AWS_SECRET_ACCESS_KEY}}
      AWS_BUCKET_NAME: ${{secrets.AWS_BUCKET_NAME}}
      AWS_BUCKET_REGION: ${{secrets.AWS_BUCKET_REGION}}

      AZURE_VOICE_SUBSCRIPTION_KEY: ${{secrets.AZURE_VOICE_SUBSCRIPTION_KEY}}
      AZURE_TOKEN_URL: https://westeurope.api.cognitive.microsoft.com/sts/v1.0/issueToken

      CTMS: http://localhost:8003
      AIHUB_ADMIN_USERNAME: testadmin
      AIHUB_ADMIN_PASSWORD: testpassword
      JWT_SECRET: db700dsfg2dd99030bc1e281cfd93422a62231959c2e156d6f7684fbb2392cc0
      JWT_ALGORITHM: HS256
      JWT_EXPIRATION_TIME:
        30

        # Add other environment variables if needed

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r /app/requirements.txt

      - name: Wait for PostgreSQL to start
        run: dockerize -wait tcp://localhost:5432 -timeout 1m

      - name: Start Central-Token-Management-System
        run: uvicorn ctms.main:ctms --port 8003

      - name: Run tests
        run: pytest /app/tests/test_main.py
